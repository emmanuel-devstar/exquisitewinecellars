name: Deploy to Pressable

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy reCAPTCHA fix files only
        env:
          SSHPASS: ${{ secrets.PRESSABLE_SSH_PASSWORD }}
          SSH_USER: ${{ secrets.PRESSABLE_SSH_USERNAME }}
          THEME_PATH: ${{ secrets.PRESSABLE_THEME_PATH }}
        run: |
          # Create list of files to deploy (reCAPTCHA fix only)
          FILES=(
            "inc/hooks.php"
            "header.php"
            "inc/utilities.php"
            "footer.php"
            "blocks/text/text.php"
            "blocks/usp/usp.php"
            "inc/lib/Configuration.php"
            "template-parts/load-recaptcha-v3.php"
            "blocks/banner-with-form/full-width.php"
            "blocks/contact/contact.js"
          )
          
          # Upload each file via SFTP
          for file in "${FILES[@]}"; do
            echo "Uploading $file..."
            dir=$(dirname "$file")
            sshpass -e sftp -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${SSH_USER}@sftp.pressable.com <<EOF
          cd ${THEME_PATH}
          -mkdir ${dir}
          put ${file} ${file}
          EOF
          done
          
          echo "âœ… reCAPTCHA fix files deployed successfully!"
